---
- name: Security Compliance & Auto-Remediation (Firewall)
  hosts: all
  become: yes                 # CRITICAL: Runs commands as root (sudo)
  gather_facts: yes           # Needed to detect OS type
  tasks:

    # =======================================
    # 1. Ubuntu / Debian Remediation
    # =======================================
    - name: Enable UFW (Ubuntu/Debian)
      ufw:
        state: enabled
        policy: allow         # Sets default to 'allow' to prevent locking yourself out
      when: ansible_os_family == 'Debian'
      register: ufw_fix

    - name: Verify UFW Status (Ubuntu)
      command: ufw status
      register: ufw_final
      changed_when: false
      when: ansible_os_family == 'Debian'

    # =======================================
    # 2. RedHat / CentOS Remediation
    # =======================================
    - name: Start & Enable Firewalld (RHEL/CentOS)
      service:
        name: firewalld
        state: started
        enabled: yes
      when: ansible_os_family == 'RedHat'

    # =======================================
    # 3. Windows Remediation
    # =======================================
    - name: Enable Windows Firewall (Domain/Public/Private)
      win_shell: Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled True
      when: ansible_os_family == 'Windows'

    # =======================================
    # 4. Final Reporting
    # =======================================
    - name: Report Remediation Success
      debug:
        msg: "COMPLIANCE FIXED: Firewall is now ENABLED and ACTIVE on {{ inventory_hostname }}"
