---
- name: Remediate Bare Pod OOM as Akshay
  hosts: all
  become: yes
  become_user: akshay
  gather_facts: false
  vars:
    target_pod_name: "oom-test-pod"
    target_namespace: "demo"
    # Increasing this to a safer threshold for the memory-hog container
    new_memory_limit: "512Mi"
    kubeconfig_path: "/home/akshay/.kube/config"

  tasks:
    - name: Dump current pod configuration to JSON
      ansible.builtin.shell: |
        kubectl get pod {{ target_pod_name }} -n {{ target_namespace }} -o json > /tmp/{{ target_pod_name }}_original.json
      args:
        chdir: /home/akshay
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Modify JSON (Strip immutable fields and set memory to 512Mi)
      ansible.builtin.shell: |
        python3 -c '
        import json, sys

        with open("/tmp/{{ target_pod_name }}_original.json", "r") as f:
            pod = json.load(f)
        
        metadata = pod.get("metadata", {})
        keys_to_remove = ["creationTimestamp", "resourceVersion", "uid", "managedFields", "ownerReferences"]
        for k in keys_to_remove:
            metadata.pop(k, None)
        pod["metadata"] = metadata
        pod.pop("status", None)
        
        for container in pod.get("spec", {}).get("containers", []):
            container["resources"] = {
                "limits": {"memory": sys.argv[1]},
                "requests": {"memory": sys.argv[1]}
            }
            
        with open("/tmp/{{ target_pod_name }}_patched.json", "w") as f:
            json.dump(pod, f)
        ' '{{ new_memory_limit }}'
      args:
        chdir: /home/akshay

    - name: Force delete the failing bare pod
      ansible.builtin.shell: |
        kubectl delete pod {{ target_pod_name }} -n {{ target_namespace }} --grace-period=0 --force
      args:
        chdir: /home/akshay
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: Recreate the pod with 512Mi memory
      ansible.builtin.shell: |
        kubectl create -f /tmp/{{ target_pod_name }}_patched.json
      args:
        chdir: /home/akshay
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
